<!DOCTYPE html>
<html>
  <head>
    <title>Портфель: Добавить сделку</title>
    <link href="/css/style.css" rel="stylesheet" />
    <link href="/bootstrap/css/bootstrap.min.css" rel="stylesheet" />

    <!-- MDBootstrap -->
    <!-- Font Awesome -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
      rel="stylesheet"
    />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap"
      rel="stylesheet"
    />
    <!-- MDB -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/3.0.0/mdb.min.css"
      rel="stylesheet"
    />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="/popper/popper.min.js"></script>
    <script src="/bootstrap/js/bootstrap.min.js"></script>

    <!-- MDBootstrap -->
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdb-ui-kit/3.0.0/mdb.min.js"></script>
  </head>

  <body>
    <header>
        <% include menu %>
    </header>
    
    <main role="main">
        <section class="container-fluid">
            <div class="section-title wrap">
                <% if (!data.isNew) { %>
                Изменить сделку
                <% } else { %>
                Добавить сделку
                <% } %>
            </div>

            <div class="">
            <form id="new-trade" name="newTrade" method="POST" action="/portfolio/<%= data.portfolio.id %>/trades" class="form needs-validation">
                <input type="hidden" id="id" name="id" value="<%= (!data.isNew) ? data.trade.id : '' %>" />
                <input type="hidden" name="portfolioId" value="<%= data.portfolio.id %>" />
                <div class="form-group">
                    <label for="type">Тип сделки:</label>
                    <select name="type" id="type" class="form-control mr-sm-2" onChange="updateForm();">
                        <option value="1" 
                            <% if (typeof data.trade !== 'undefined' && data.trade.secid !== data.portfolio.currency) { %>
                            selected="selected"
                            <% } %>
                        >Акция/ПИФ/ETF</option>
                        <option value="2" 
                            <% if (typeof data.trade !== 'undefined' && data.trade.secid === data.portfolio.currency) { %>
                            selected="selected"
                            <% } %>
                        >Деньги</option>
                    </select>
                    <!-- <label for="secid" class="">Тикер компании*</label> -->
                    <label for="secid">Тикер:</label>
                    <select name="secid" class="form-control mr-sm-2" id="secid" searchable="Search here..">
                        <option value="" disabled selected>Выберите бумагу</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="operationId" class="">Операция:</label>
                    <select id="operationId" class="form-control mr-sm-2" name="operationId" >
                        <% data.operations.forEach(row => { %>
                            <option value="<%= row.id %>" 
                                <% if (typeof data.trade !== 'undefined' && row.id == data.trade.operationId) { %>
                                selected="selected"
                                <% } %>
                            ><%= row.title %></option>
                        <% }) %>
                    </select>
                    <label for="date" class="">Дата:*</label>
                    <input type="date" id="date" class="form-control sm-2" name="date" value="<% if (typeof data.date !== 'undefined') { %><% if (typeof data.date == 'object') {%><%=data.date.toISOString().slice(0,10)%><%} else {%><%=data.date%><%}%><%}else{%>2020-01-01<%}%>" />
                    <label for="price" class="" id="labelPrice">Цена:*</label>
                    <input type="text" id="price" class="form-control sm-2" name="price" value="<%= (typeof data.trade !== 'undefined') ? data.trade.price : '' %>" placeholder="Цена" />
                    <label for="amount" class="" id="labelAmount">Количество:*</label>
                    <input type="text" id="amount" class="form-control mr-sm-2" name="amount" value="<%= (typeof data.trade !== 'undefined') ? data.trade.amount : 1 %>" placeholder="Количество" />
                </div>

                <div class="form-group">
                    <label for="comission">Комиссия:</label>
                    <input type="text" id="comission" class="form-control" name="comission" value="<%= (typeof data.trade !== 'undefined') ? data.trade.comission : 0 %>" placeholder="Комиссия" />
                </div>

                <div class="form-group">
                    <label for="comment">Заметка:</label>
                    <input type="text" id="comment" class="form-control" name="comment" value="<%= (typeof data.trade !== 'undefined') ? data.trade.comment : '' %>" placeholder="Заметка" />
                </div>

                <div class="form-group justify-center">
                    <button type="submit" class="btn btn-primary btn-sm mr-sm-2" name="action" value="save">Сохранить</button>
                    <button type="submit" class="btn btn-primary btn-sm" name="action" value="cancel">Отменить</button>
                </div>

            </form>
            </div>
        </section>
    </main>

    <footer>
    </footer>

    <script>

        function updateForm() {
            var type = $("#type :selected").val();

                switch(type) {
                    case '1':
                        
                        $("#secid").show();
                        $("secid").empty();
                        buildSelect();

                        $("#operationId option[value=1]").text('Покупка');
                        $("#operationId option[value=2]").text('Продажа');
                        if ($("#operationId option").size == 2) {
                            $("#operationId").append('<option value="3">Дивиденд</option>');
                        } else {
                            $("#operationId option[value=3]").text('Дивиденд');
                        }

                        $("#labelPrice").text("Цена:*");

                        $("#amount").show();
                        $("#labelAmount").show();

                        break;
                    case '2':
                        $("#secid").empty();
                        $("#secid").append('<option value="RUB" selected="selected">Деньги</option>');
                        // $("#secid").hide();

                        $("#operationId option[value=1]").text('Внести');
                        $("#operationId option[value=2]").text('Вывести');
                        $("#operationId option[value=3]").remove();

                        $("#labelPrice").text("Сумма:*");

                        $("#amount").val('1');
                        $("#amount").hide();
                        $("#labelAmount").hide();


                        break;
                }
        }

        function buildSelect() {

            const securities = <%- JSON.stringify(data.securities) %>

            $("#secid").empty();
            $("#secid").append('<option value="" disabled selected>Выберите бумагу</option>');
             // construct options for secid select
            securities.forEach(function(security) {
                $("#secid").append('<option value="'+security.secid+'">'+security.secid+' ('+security.name+') ('+security.group+')</option>')
            })

            var secid = <%if (typeof data.trade !== 'undefined') {%><%- JSON.stringify(data.trade.secid) %><%} else {%><%=null%><%}%>

            $("#secid option[value='"+secid+"']").attr("selected","selected");
        }

        $(document).ready(function() {

                
                buildSelect();
                updateForm();
        });

    </script>

    <script>
        $(document).ready(function(e) {

            function insertAfter(referenceNode, newNode) {
                referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
            }


            var err = <%if (typeof error !== 'undefined') {%><%- JSON.stringify(error) %><%} else {%><%=null%><%}%>;
            
            if (err) {

                for (var i = 0; i<err.errors.length; i++) {
                    var el_id = err.errors[i].path;

                    var el = document.getElementById(el_id);
                    el.classList.add("is-invalid");
                    
                    var div = document.createElement("div");
                    div.classList.add("invalid-feedback");
                    div.innerHTML = err.errors[i].message;

                    insertAfter(el, div);

                    el.addEventListener('change', function (event) {
                        event.target.classList.remove("is-invalid");
                        event.target.nextElementSibling.remove();
                    });
                }

            }
        })
    </script>
    
    

    </body>
    
</html>