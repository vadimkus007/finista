<% layout('../layout/portfolio') %>
<% var title = 'Сделки - ' + data.portfolio.title; %>
<% block('title', title) %>
<% block('menu', 'portfolios trades') %>
<% stylesheet('/vendor/datatables/dataTables.bootstrap4.min.css') -%>
<% script('/vendor/datatables/jquery.dataTables.min.js') %>
<% script('/vendor/datatables/dataTables.bootstrap4.min.js') %>
<% script('/js/tradesTable.js') %>

<form method="POST" action="/portfolio/<%= data.portfolio.id %>/trades" class="" role="form">           
    <input type="hidden" id="tradeId" name="id" value="" />
    <input type="hidden" id="portfolioId" name="portfolioId" value="" />
    <input type="hidden" id="operationId" name="operationId" value="" />
            
    <section class="row">

        <div id="toolbar" class="toolbar col-lg-12" role="toolbar">
            <div class="mb-4">
                <button type="submit" class="btn-primary btn btn-sm" name="action" value="edit">
                    <div class="btn-content">
                        Добавить сделку
                    </div>
                </button>
            </div>
        </div>
                
        <div class="col-lg-12">

            <table class="table table-striped table-bordered table-hover" id="tradesTable">
                                <thead>
                                    <tr>
                                        <th>Тикер</th>
                                        <th>Операция</th>
                                        <th>Дата</th>
                                        <th>Количество</th>
                                        <th>Цена</th>
                                        <th>Комиссия</th>
                                        <th>Сумма</th>
                                        <th class="text-xs-right" role="columnheader" width="50"></th>
                                    </tr>
                                </thead>

                                <tbody>
                                    <% data.trades.forEach(row => { %>
                                    <tr>
                                        <td>
                                            <% if (row.secid === 'RUB') { %>
                                                Деньги
                                            <% } else { %>
                                            <%= row.secid %>
                                            <% } %>
                                        </td>
                                        <td><%= row['operation.title'] %></td>
                                        <td><%= row.date.toISOString().slice(0,10) %></td>
                                        <td><%= row.amount %></td>
                                        <td><%= row.price %></td>
                                        <td><%= row.comission %></td>
                                        <td><%= ((row.price * row.amount) + 1*row.comission).toFixed(2) %></td>
                                        <td>
                                            <div class="flex" style="width: 75px;">
                                            <button type="submit" class="btn btn-sm flex-child" style="display:inline-block;" name="action" value="edit" placeholder="Редактировать" onClick="setHiddenFields(<%= row.id %>,<%= row.portfolioId %>,<%= row.operationId %>);"><img src="/img/edit-16.png" /></button>
                                            <button type="submit" class="btn btn-sm flex-child" style="display:inline-block;" name="action" value="delete" placeholder="Удалить" onClick="if (confirm('Дествительно удалить сделку?')) {setHiddenFields(<%= row.id %>,<%= row.portfolioId %>,<%= row.operationId %>)};"><img src="/img/delete-16.png" /></button>
                                            </div>
                                        </td>
                                    </tr>
                                    <% }) %>
                                </tbody>

                            </table>

        </div>               
    </section>
</form>
  
    <script>
        function setHiddenFields(id, portfolioId, operationId) {
            document.getElementById('tradeId').value = id;
            document.getElementById('portfolioId').value = portfolioId;
            document.getElementById('operationId').value = operationId;
        }
    </script>


