<% layout('../layout/page') %>
<% var title = 'Сделки - ' + data.portfolio.title; %>
<% block('title', title) %>
<% block('menu', 'portfolio trades') %>
<% stylesheet('/vendor/datatables/dataTables.bootstrap4.min.css') -%>
<% script('/vendor/datatables/jquery.dataTables.min.js') %>
<% script('/vendor/datatables/dataTables.bootstrap4.min.js') %>
<% script('/js/tradesTable.js') %>

<form method="POST" action="/portfolio/trades" class="" role="form">           
    <input type="hidden" id="tradeId" name="id" value="" />
    <input type="hidden" id="portfolioId" name="portfolioId" value="" />
    <input type="hidden" id="operationId" name="operationId" value="" />
            
    <section class="row">

        <div id="toolbar" class="toolbar col-lg-12" role="toolbar">
            <div class="mb-4">
                <button type="submit" class="btn-primary btn btn-sm" name="action" value="edit">
                    <div class="btn-content">
                        Добавить сделку
                    </div>
                </button>
            </div>
        </div>
                
        <div class="col-lg-12">

            <table class="table table-striped table-bordered table-hover" id="tradesTable">
                                <thead>
                                    <tr>
                                        <th>Тикер</th>
                                        <th>Операция</th>
                                        <th>Дата</th>
                                        <th>Количество</th>
                                        <th>Цена</th>
                                        <th>Комиссия</th>
                                        <th>Сумма</th>
                                        <th class="text-xs-right no-sort" role="columnheader" width="20"></th>
                                    </tr>
                                </thead>

                                <tbody>
                                    <% data.trades.forEach(row => { %>
                                    <tr>
                                        <td>
                                            <% if (row.secid === 'RUB') { %>
                                                Деньги
                                            <% } else { %>
                                            <%= row.secid %>
                                            <% } %>
                                        </td>
                                        <td><%= row['operation.title'] %></td>
                                        <td><%= row.date.toISOString().slice(0,10) %></td>
                                        <td><%= row.amount %></td>
                                        <td>
                                            <% if (row.operationId == 7 || row.operationId == 4) { %>
                                                <%= Number((row.price * row.value / 100) + 1*row.accint).toFixed(2) %>
                                            <% } else if (row.operationId == 8) { %>
                                                <%= Number((row.price * row.value / 100) - 1*row.accint).toFixed(2) %>
                                            <% } else { %>
                                                <%= row.price %>
                                            <% } %>
                                                
                                        </td>
                                        <td><%= row.comission %></td>
                                        <td>
                                            <% if (row.operationId == 7 || row.operationId == 4) { %>
                                                <%= Number(row.amount*((row.price * row.value / 100) + 1*row.accint) + 1*row.comission).toFixed(2) %>
                                            <% } else if (row.operationId == 8) { %>
                                                <%= Number(row.amount*((row.price * row.value / 100) - 1*row.accint) + 1*row.comission).toFixed(2) %>
                                            <% } else { %>
                                                <%= Number(row.amount*row.price + 1*row.comission).toFixed(2) %>
                                            <% } %>
                                            
                                        </td>
                                        <td>
                                            
                                            <!-- Dropdown menu in cells -->
                                            <ul class="navbar-nav ml-auto">
                                                <li class="nav-item dropdown no-arrow mx-1">
                                                    <a class="nav-link dropdown-toggle" href="#" role="button"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                        <i class="fas fa-fw fa-ellipsis-h"></i>
                                                    </a>
                                        <div class="dropdown-menu dropdown-menu-right shadow"
                                                    aria-labelledby="userDropdown">
                                            
                                            <button type="submit" class="btn btn-sm dropdown-item" style="display:inline-block;" name="action" value="edit" placeholder="Редактировать" onClick="setHiddenFields(<%= row.id %>,<%= row.portfolioId %>,<%= row.operationId %>);">
                                                <i class="fas fa-edit fa-sm fa-fw mr-2 text-gray-400"></i>
                                                Редактировать
                                            </button>

                                            <button type="submit" class="btn btn-sm dropdown-item" style="display:inline-block;" name="action" value="delete" placeholder="Удалить" onClick="if (confirm('Дествительно удалить сделку?')) {setHiddenFields(<%= row.id %>,<%= row.portfolioId %>,<%= row.operationId %>)};">
                                                <i class="fas fa-times fa-sm fa-fw mr-2 text-gray-400"></i>
                                                Удалить
                                            </button>
                                        </div>

                                                </li>
                                            </ul>
                                            <!-- Dropdown menu in cells -->

                                        </td>
                                    </tr>
                                    <% }) %>
                                </tbody>

                            </table>

        </div>               
    </section>
</form>
  
    <script>
        function setHiddenFields(id, portfolioId, operationId) {
            document.getElementById('tradeId').value = id;
            document.getElementById('portfolioId').value = portfolioId;
            document.getElementById('operationId').value = operationId;
        }
    </script>


